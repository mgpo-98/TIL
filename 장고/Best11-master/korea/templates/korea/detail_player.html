{% extends 'base.html' %}
{% load static %}

{% block content %}

  <!-- 선수별 뇌피셜 페이지 -->

  <style>
    .player-comment img {
      object-fit: cover;
      transform: scale(0.7);
    }
  </style>

  <!-- <header> <script> function getCookie(name) { var cookieValue = null; if (document.cookie && document.cookie !== '') { var cookies = document.cookie.split(';'); for (var i = 0; i < cookies.length; i++) { var cookie = cookies[i].trim(); // Does this cookie string begin with the name we want? if (cookie.substring(0, name.length + 1) === (name + '=')) { cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break; } } } return cookieValue; } var csrftoken = getCookie('csrftoken'); function csrfSafeMethod(method) { // these HTTP methods do not require CSRF protection return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method)); } $.ajaxSetup({ beforeSend: function (xhr, settings) { if (!csrfSafeMethod(settings.type) && !this.crossDomain) { xhr.setRequestHeader("X-CSRFToken", csrftoken); } } }); </script> </header> -->
  <div class="container-css">
    <!-- 선수 정보 -->
    <div class="d-flex flex-column justify-content-center align-items-center m-0">
      <div class="player-pic-wrapper mb-5">
        <img class="player-pic" src="{{ player.player_image }}" alt="선수 사진">
      </div>
      <h2 class="text-center fw-bold mb-0" style="font-size: 2.5rem;">
        {{ player.name }}
      </h2>
      <p class="fw-bold mb-0" style="font-size: 2.5rem;">
        {{ player.english_name }}
      </p>
      <p class="fw-bold mb-4" style="font-size: 2.5rem;">
        <span>
          {{ player.back_number }}
        </span>
        <span class="text-red">
          {{ player.position }}
        </span>
      </p>
      <p style="font-size: 1.8rem;">
        {{ player.birthdate }}
        /
        {{ player.height }}cm /
        {{ player.weight }}kg
      </p>
      <p style="font-size: 1.8rem;">
        {{ player.team }}
      </p>
      <p class="text-muted mt-4">
        소속은 대표팀으로 선발되었을 당시 소속 입니다.
      </p>
      <!-- 응원하기 버튼 -->
      <div>
        {% if request.user.is_authenticated %}
          <form class="like-forms d-flex justify-content-center" data-player-id="{{ player.pk }}">
            {% csrf_token %}
            {% if request.user in player.fans.all %}
              <input type="submit" class="btn btn-outline-navy mt-3 mb-1" id="like-{{ player.pk }}" value="응원취소">
            {% else %}
              <input type="submit" class="btn btn-navy mt-3 mb-1" id="like-{{ player.pk }}" value="응원하기">
            {% endif %}
          </form>
        {% endif %}
        <small>
          <span id="like-count">{{player.fans.all|length}}</span>명이 응원해요</small>
      </div>
    </div>

    <!-- 하단 채팅 레이아웃 -->
    <div class="d-flex justify-content-center my-5">
      <div class="col-8" style="width: 50rem;">
        <div class="wrap row justify-content-center">
          <!-- 입력창 모양 -->
          <div class="col-11">
            <p class="text-navy fw-bold mb-4" style="font-size: 1.8rem;">{{ player.comment_set.count }}개의 피셜</p>
            <a href="{% url 'korea:comment_create' player.pk %}">
              <div class="input-group mb-3" style="height: 4.1rem;">
                <input disabled="disabled" style="background-color: white;" type="text" class="form-control" placeholder="선수에 대해 알고있는 정보를 공유해 주세요!" aria-label="피셜 작성" aria-describedby="basic-addon2">
                <span class="input-group-text text-white d-flex justify-content-center" id="basic-addon2" style="width: 10rem; font-size: 1.6rem; background-color: #111b54;">등록</span>
              </div>
            </a>
          </div>

          <!-- 피셜 출력 -->
          {% for comment in comments %}
            <div class="chat ch1 align-items-center">
              <div class="textbox">
                <div class="d-flex justify-content-between mb-4">
                  <a class="a-navy-red fw-bold" href="{% url 'accounts:detail' comment.user.pk %}">{{ comment.user.username }}</a>
                  <div>
                    <small class="text-muted">
                      <i class="bi bi-suit-heart-fill" id="like-count-{{ comment.pk }}">{{ comment.like_users.all|length }}</i>
                    </small>
                    <small class="text-muted">|</small>
                    <small class="text-muted">
                      {% if comment.created_string == False %}
                        <span>{{ comment.created|date:'m월 d일' }}</span>
                      {% else %}
                        <span>{{ comment.created_string }}</span>
                      {% endif %}
                    </small>

                    <!-- {% if comment.is_updated == False %} <small class="text-muted"> {% if comment.created_string == False %} {{ comment.created_at|date:'Y.m.d' }} {% else %} {{ comment.created_string }} {% endif %} </small> {% else %} <small class="text-muted"> {% if comment.created_string == False %} {{ comment.updated_at|date:'Y.m.d' }} {% else %} {{ comment.created_string }} {% endif %} (수정됨) </small> {% endif %} -->

                    <small class="text-muted">|</small>
                    <!-- 작성자만 수정 삭제 -->
                    {% if user.is_authenticated and comment.user == request.user %}
                      <a href="{% url 'korea:comment_update' player.pk comment.pk %}" class="small text-muted">수정</a>
                      <small class="text-muted">|</small>
                      <a href="{% url 'korea:comment_delete' player.pk comment.pk %}" class="small text-muted">삭제</a>
                    {% else %}
                      <a href="" class="small text-muted" data-bs-toggle="modal" data-bs-target="#reportModal">신고</a>
                      <!-- 신고 Modal -->
                      <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered d-flex justify-content-center">
                          <div class="modal-content" style="width: 40rem; height: rem;">
                            <div class="d-flex justify-content-end my-4">
                              <button type="button" class="btn-close me-4" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center">
                              해당 피셜을 신고하시겠어요?
                            </div>
                            <div class="d-flex justify-content-center my-4">
                              <button type="button" class="btn btn-navy me-1" data-bs-dismiss="modal">취소</button>
                              <button type="button" class="btn btn-outline-navy ms-2">신고하기</button>
                            </div>
                          </div>
                        </div>
                      </div>
                      <!-- 신고 Modal -->
                    {% endif %}
                  </div>
                </div>

                <!-- 피셜 내용 -->
                <p class="">
                  <!-- 이미지가 있으면 크기 조정-->
                  {{ comment.content | safe }}
                </p>
              </div>

              <!-- 좋아요 버튼 -->
              {% if request.user.is_authenticated %}
                <form class="like-form" data-comment-id="{{ comment.pk }}" data-player-id="{{ player.pk }}">
                  {% csrf_token %}
                  {% if request.user in comment.like_users.all %}
                    <button class="btn border-0 ms-3" style="background-color: transparent;" type="submit" id="like-comment-{{ comment.pk }}">
                      <i id="like-i-{{ comment.pk }}" class="like-fficial bi bi-suit-heart-fill"></i>
                    </button>
                  {% else %}
                    <button class="btn border-0 ms-3" style="background-color: transparent;" type="submit" id="like-comment-{{ comment.pk }}">
                      <i id="like-i-{{ comment.pk }}" class="like-fficial bi bi-suit-heart"></i>
                    </button>
                  {% endif %}
                </form>
              {% endif %}

            </div>
          {% endfor %}

        </div>
        <!-- wrap -->
      </div>
      <!-- col-8 -->
    </div>
    <!-- 하단 채팅 레이아웃 -->
  </div>
  <!-- container -->

  <!-- script -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.bundle.js"></script>

  <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script> <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script> -->

  <script>
    // summernote 적용, 커스텀
    $('#summernote').summernote({
      height: 300,
      focus: true,
      maxWidth: 500,
      lang: 'ko-KR',
      callbacks: {
        onImageUpload: function (image) {
          var file = image[0];
          var reader = new FileReader();
          reader.onloadend = function () {
            var image = $('<img>').attr('src', reader.result);
            image.attr('width', '100%');
            $('#summernote').summernote("insertNode", image[0]);
          }
          reader.readAsDataURL(file);
        }
      }
    });
  </script>

  <script type="text/javascript">
    // 페이지 벗어나기 경고창
    var checkUnload = true;
    $(window).on('beforeunload', function () {
      if (checkUnload) 
        return "이 페이지를 벗어나면 작성된 내용은 저장되지 않습니다.";
      }
    );
    $("#write").on("click", function () {
      checkUnload = false;
      $("submit").submit();
    });
  </script>

  <!-- <script type="text/javascript" src="cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script> <script type="text/javascript" src="/static/js/lang/summernote-ko-KR.js"></script> <script src="summernote-bs5.js"></script> -->

  <script>
    // 선수 응원하기
    const forms = document.querySelectorAll(".like-forms")
    const csrftoken = document
      .querySelector('[name=csrfmiddlewaretoken]')
      .value

      forms
      .forEach((form) => {
        form.addEventListener('submit', function (event) {
          event.preventDefault();
          const playerId = event
            .target
            .dataset
            .playerId

            axios({
              method: 'post',
              url: `/korea/like_player/${playerId}`,
              headers: {
                'X-CSRFToken': csrftoken
              }
            })
            .then((response) => {
              console.log(response.data)
              const isLikeds = response.data.is_likeds
              const likeBtn = document.querySelector(`#like-${playerId}`)
              if (isLikeds === true) {
                likeBtn.value = "응원취소"
              } else {
                likeBtn.value = "응원하기"
              }
              const likeCountTag = document.querySelector('#like-count')
              const likeCount = response.data.like_count
              likeCountTag.innerText = likeCount
            })
        })
      })
  </script>

  <script>
    // 좋아요
    const form = document.querySelectorAll('.like-form')
    console.log(form)
    const csrftokens = document
      .querySelector('[name=csrfmiddlewaretoken]')
      .value

      form
      .forEach((form) => {
        form.addEventListener('submit', function (event) {
          event.preventDefault()
          const playerId = event.target.dataset.playerId
          const commentId = event
            .target
            .dataset
            .commentId

            axios({
              method: 'post',
              url: `/korea/detail/${playerId}/${commentId}/likes/`,
              headers: {
                'X-CSRFToken': csrftokens
              }
            })
            .then((response) => {
              const isLiked = response.data.is_liked
              const likeBtn = document.querySelector(`#like-i-${commentId}`)
              if (isLiked === true) {
                likeBtn
                  .classList
                  .remove('bi-suit-heart')
                likeBtn
                  .classList
                  .add('bi-suit-heart-fill')
              } else {
                likeBtn
                  .classList
                  .remove('bi-suit-heart-fill')
                likeBtn
                  .classList
                  .add('bi-suit-heart')
              }
              const likeCountTag = document.querySelector(`#like-count-${commentId}`)
              const likeCount = response.data.likeCount
              likeCountTag.innerText = likeCount
            })
            .catch((error) => {
              console.log(error.response)
            })
          })
      })
  </script>

{% endblock %}